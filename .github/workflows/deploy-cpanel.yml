name: Deploy Frontend to cPanel

on:
  push:
    branches:
      - dev
      - staging
      - main

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    env:
      # Optional Cloudflare cache purge (leave empty if not used)
      CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Select deployment target and env vars
        id: sel
        shell: bash
        run: |
          BRANCH="${GITHUB_REF##*/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == "dev" ]]; then
            echo "env=dev" >> $GITHUB_OUTPUT
            echo "CPANEL_HOST=${{ secrets.CPANEL_HOST_DEV }}" >> $GITHUB_OUTPUT
            echo "CPANEL_USER=${{ secrets.CPANEL_USER_DEV }}" >> $GITHUB_OUTPUT
            echo "CPANEL_PASSWORD=${{ secrets.CPANEL_PASSWORD_DEV }}" >> $GITHUB_OUTPUT
            dest="${{ secrets.CPANEL_DEST_DEV }}"
            if [[ "$dest" != */ ]]; then dest="$dest/"; fi
            echo "CPANEL_DEST=$dest" >> $GITHUB_OUTPUT
            cs="${{ secrets.CLEAN_SLATE_DEV }}"; if [[ "$cs" != "true" ]]; then cs="false"; fi; echo "CLEAN_SLATE=$cs" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY_DEV }}" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID_DEV }}" >> $GITHUB_OUTPUT
            echo "VITE_TURNSTILE_SITE_KEY=${{ secrets.VITE_TURNSTILE_SITE_KEY_DEV }}" >> $GITHUB_OUTPUT
            echo "VITE_SERVICE_API_URL=${{ secrets.VITE_SERVICE_API_URL_DEV }}" >> $GITHUB_OUTPUT
            echo "VITE_MAINTENANCE_AUTH=${{ secrets.VITE_MAINTENANCE_AUTH_DEV || 'false' }}" >> $GITHUB_OUTPUT
            echo "VITE_MAINTENANCE_PRODUCT=${{ secrets.VITE_MAINTENANCE_PRODUCT_DEV || 'false' }}" >> $GITHUB_OUTPUT
            echo "VITE_SHOPEE_URL=${{ secrets.VITE_SHOPEE_URL || 'https://shopee.co.id' }}" >> $GITHUB_OUTPUT
            echo "VITE_TIKTOK_SHOP_URL=${{ secrets.VITE_TIKTOK_SHOP_URL || 'https://www.tiktok.com' }}" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "stg" ]]; then
            echo "env=stg" >> $GITHUB_OUTPUT
            echo "CPANEL_HOST=${{ secrets.CPANEL_HOST_STG }}" >> $GITHUB_OUTPUT
            echo "CPANEL_USER=${{ secrets.CPANEL_USER_STG }}" >> $GITHUB_OUTPUT
            echo "CPANEL_PASSWORD=${{ secrets.CPANEL_PASSWORD_STG }}" >> $GITHUB_OUTPUT
            dest="${{ secrets.CPANEL_DEST_STG }}"
            if [[ "$dest" != */ ]]; then dest="$dest/"; fi
            echo "CPANEL_DEST=$dest" >> $GITHUB_OUTPUT
            cs="${{ secrets.CLEAN_SLATE_STG }}"; if [[ "$cs" != "true" ]]; then cs="false"; fi; echo "CLEAN_SLATE=$cs" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL_STG }}" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY_STG }}" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID_STG }}" >> $GITHUB_OUTPUT
            echo "VITE_TURNSTILE_SITE_KEY=${{ secrets.VITE_TURNSTILE_SITE_KEY_STG }}" >> $GITHUB_OUTPUT
            echo "VITE_SERVICE_API_URL=${{ secrets.VITE_SERVICE_API_URL_STG }}" >> $GITHUB_OUTPUT
            echo "VITE_MAINTENANCE_AUTH=${{ secrets.VITE_MAINTENANCE_AUTH_STG || 'false' }}" >> $GITHUB_OUTPUT
            echo "VITE_MAINTENANCE_PRODUCT=${{ secrets.VITE_MAINTENANCE_PRODUCT_STG || 'false' }}" >> $GITHUB_OUTPUT
            echo "VITE_SHOPEE_URL=${{ secrets.VITE_SHOPEE_URL || 'https://shopee.co.id' }}" >> $GITHUB_OUTPUT
            echo "VITE_TIKTOK_SHOP_URL=${{ secrets.VITE_TIKTOK_SHOP_URL || 'https://www.tiktok.com' }}" >> $GITHUB_OUTPUT
          else
            echo "env=prod" >> $GITHUB_OUTPUT
            echo "CPANEL_HOST=${{ secrets.CPANEL_HOST_PROD }}" >> $GITHUB_OUTPUT
            echo "CPANEL_USER=${{ secrets.CPANEL_USER_PROD }}" >> $GITHUB_OUTPUT
            echo "CPANEL_PASSWORD=${{ secrets.CPANEL_PASSWORD_PROD }}" >> $GITHUB_OUTPUT
            dest="${{ secrets.CPANEL_DEST_PROD }}"
            if [[ "$dest" != */ ]]; then dest="$dest/"; fi
            echo "CPANEL_DEST=$dest" >> $GITHUB_OUTPUT
            cs="${{ secrets.CLEAN_SLATE_PROD }}"; if [[ "$cs" != "true" ]]; then cs="false"; fi; echo "CLEAN_SLATE=$cs" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY_PROD }}" >> $GITHUB_OUTPUT
            echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID_PROD }}" >> $GITHUB_OUTPUT
            echo "VITE_TURNSTILE_SITE_KEY=${{ secrets.VITE_TURNSTILE_SITE_KEY_PROD }}" >> $GITHUB_OUTPUT
            echo "VITE_SERVICE_API_URL=${{ secrets.VITE_SERVICE_API_URL_PROD }}" >> $GITHUB_OUTPUT
            echo "VITE_MAINTENANCE_AUTH=${{ secrets.VITE_MAINTENANCE_AUTH_PROD || 'false' }}" >> $GITHUB_OUTPUT
            echo "VITE_MAINTENANCE_PRODUCT=${{ secrets.VITE_MAINTENANCE_PRODUCT_PROD || 'false' }}" >> $GITHUB_OUTPUT
            echo "VITE_SHOPEE_URL=${{ secrets.VITE_SHOPEE_URL || 'https://shopee.co.id' }}" >> $GITHUB_OUTPUT
            echo "VITE_TIKTOK_SHOP_URL=${{ secrets.VITE_TIKTOK_SHOP_URL || 'https://www.tiktok.com' }}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: npm ci

      - name: Verify required env vars
        env:
          VITE_SUPABASE_URL: ${{ steps.sel.outputs.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ steps.sel.outputs.VITE_SUPABASE_PUBLISHABLE_KEY }}
        shell: bash
        run: |
          missing=0
          for var in VITE_SUPABASE_URL VITE_SUPABASE_PUBLISHABLE_KEY; do
            if [[ -z "${!var}" ]]; then
              echo "::error ::$var is not set for environment ${{ steps.sel.outputs.env }}. Configure it in GitHub Secrets (e.g., ${var}_DEV/STG/PROD).";
              missing=1
            fi
          done
          if [[ $missing -ne 0 ]]; then exit 1; fi
          echo "All required env vars present."

      - name: Build
        env:
          VITE_SUPABASE_URL: ${{ steps.sel.outputs.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ steps.sel.outputs.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_PROJECT_ID: ${{ steps.sel.outputs.VITE_SUPABASE_PROJECT_ID }}
          VITE_TURNSTILE_SITEKEY: ${{ steps.sel.outputs.VITE_TURNSTILE_SITE_KEY }}
          VITE_MAINTENANCE_AUTH: ${{ steps.sel.outputs.VITE_MAINTENANCE_AUTH }}
          VITE_MAINTENANCE_PRODUCT: ${{ steps.sel.outputs.VITE_MAINTENANCE_PRODUCT }}
          VITE_SHOPEE_URL: ${{ steps.sel.outputs.VITE_SHOPEE_URL }}
          VITE_TIKTOK_SHOP_URL: ${{ steps.sel.outputs.VITE_TIKTOK_SHOP_URL }}
          VITE_SERVICE_API_URL: ${{ steps.sel.outputs.VITE_SERVICE_API_URL }}
        run: npm run build

      - name: Deploy via FTPS to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ steps.sel.outputs.CPANEL_HOST }}
          username: ${{ steps.sel.outputs.CPANEL_USER }}
          password: ${{ steps.sel.outputs.CPANEL_PASSWORD }}
          port: 21
          protocol: ftps
          local-dir: dist/
          server-dir: ${{ steps.sel.outputs.CPANEL_DEST }}
          dangerous-clean-slate: false
          log-level: verbose
          timeout: 60000
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/src/**
            **/README.md
            **/package*.json
            **/tsconfig*.json
            **/vite.config.*

      - name: Purge Cloudflare cache (optional)
        if: ${{ env.CF_ZONE_ID != '' && env.CF_API_TOKEN != '' }}
        uses: jakejarvis/cloudflare-purge-action@v0.3.0
        with:
          zone: ${{ env.CF_ZONE_ID }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CF_API_TOKEN }}
